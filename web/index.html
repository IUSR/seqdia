<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Simple Sequence</title>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.2.0/build/cssreset/reset-min.css">
    <link rel="stylesheet" href="./css/sequence.css">

    <script src="./js/jquery.js" type="text/javascript"></script>
    <script src="./js/jquery.ui.min.js" type="text/javascript"></script>
    <script src="js/drawers/lifeline.js" type="text/javascript"></script>
    <script src="js/drawers/rect.js" type="text/javascript"></script>
    <script src="js/drawers/grid.js" type="text/javascript"></script>
    <script src="js/drawers/label.js" type="text/javascript"></script>
    <script src="js/drawers/arrow_icon_right.js" type="text/javascript"></script>
    <script src="js/drawers/arrow_icon_left.js" type="text/javascript"></script>
    <script src="js/drawers/line.js" type="text/javascript"></script>
    <script src="js/drawers/label.js" type="text/javascript"></script>
    <script src="js/drawers/horizontal_line.js" type="text/javascript"></script>
    <script src="js/drawers/horizontal_arrow.js" type="text/javascript"></script>
    <script src="js/drawers/bar.js" type="text/javascript"></script>
    <script src="js/drawers/entity.js" type="text/javascript"></script>
    <script src="js/drawers/message.js" type="text/javascript"></script>
    <script src="js/drawers/internal_invoke.js" type="text/javascript"></script>
    <script src="js/domain/entities.js" type="text/javascript"></script>
    <script src="js/domain/message.js" type="text/javascript"></script>
    <script src="js/domain/activity_sequence.js" type="text/javascript"></script>
    <script src="./js/presentation/canvas_manager.js" type="text/javascript"></script>
    <script src="./js/presentation/presentation_entity.js" type="text/javascript"></script>
    <script src="./js/presentation/presentation_message.js" type="text/javascript"></script>
    <script src="./js/presentation/presentation_bar.js" type="text/javascript"></script>
    <script src="./js/parser/message_parser.js" type="text/javascript"></script>

    <script type="text/javascript">

        jQuery(window).load(function() {
            if (jQuery.browser.safari && document.readyState != 'complete') {
                // chrome / safari will trigger load function before images are finished
                // check readystate in safari browser to ensure images are done loading
                setTimeout(arguments.callee, 100);
                return;
            }
            // do things you want to do
            window.canvasManager = new CanvasManager($('#canvasContainer'));
            window.canvasManager.drawGrid();

            window.activitySequence = new ActivitySequence("");

            window.redraw();
        });


        function collapse() {
            if ($("#floating_container").hasClass("collapse")) {
                $("#floating_container").removeClass("collapse");
                $("#floating_container").addClass("expand");
            } else {
                $("#floating_container").removeClass("expand");
                $("#floating_container").addClass("collapse");
            }
        }

        // draw vertical line
        function vertical_cairo_curve_to(context, fromX, fromY, toY) {
            var controlX,controlY;
            var offsetX = 5;
            var offsetY = 5;
            controlX = fromX + offsetX * (Math.random() - 0.5);
            var tmpToY = fromY + 200;
            if (tmpToY > toY) tmpToY = toY;

            controlY = fromY / 2 + tmpToY / 2 + offsetY * (Math.random() - 0.5);
            //            context.moveTo(fromX, fromY);
            context.quadraticCurveTo(controlX, controlY, fromX, tmpToY);
            if (toY > tmpToY)
                vertical_cairo_curve_to(context, fromX, tmpToY, toY);
        }

        // draw horizontal line
        function horizontal_cairo_curve_to(context, fromX, fromY, toX) {
            var controlX,controlY;
            var offsetX = 5;
            var offsetY = 5;
            controlY = fromY + offsetY * (Math.random() - 0.5);
            if (toX > fromX) {
                var tmpToX = fromX + 20;
                if (tmpToX > toX) tmpToX = toX;
            } else {
                var tmpToX = fromX - 20;
                if (tmpToX < toX) tmpToX = toX;
            }

            controlX = fromX / 2 + tmpToX / 2 + offsetX * (Math.random() - 0.5);
            context.quadraticCurveTo(controlX, controlY, tmpToX, fromY);
            if ((toX > fromX && toX > tmpToX) || (toX < fromX && toX < tmpToX))
                horizontal_cairo_curve_to(context, tmpToX, fromY, toX);
        }

        function crazy_rect(context, left, top, width, height, radius) {
            var t0 = new Date().getTime();

            context.moveTo(left + radius, top);
            horizontal_cairo_curve_to(context, left + radius, top, left + width - radius);
            context.quadraticCurveTo(left + width, top, left + width, top + radius);
            //            context.lineTo(left + width, top + height - radius);
            vertical_cairo_curve_to(context, left + width, top + radius, top + height - radius);
            context.quadraticCurveTo(left + width, top + height, left + width - radius, top + height);
            horizontal_cairo_curve_to(context, left + width - radius, top + height, left + radius);
            context.quadraticCurveTo(left, top + height, left, top + height - radius);
            context.lineTo(left, top + radius);
            context.quadraticCurveTo(left, top, left + radius, top);
            var t1 = new Date().getTime();
            //            $('#perf').text(t1 - t0);

        }

        window.redraw = function () {
            var scriptContent = $("#script_content")[0].value;
            var t0 = new Date().getTime();
            window.activitySequence.draw(window.canvasManager, scriptContent);
            window.lastXOffset = 0;
            var t1 = new Date().getTime();
            //            $('#perf').text(t1 - t0);
        };

        function startMove(event) {
            //            alert(event.screenX + " left " + event.screenY + " down")
            $('#canvasContainer')[0].onmousemove = dragCanvas;
            window.orignalX = event.screenX;
        }

        function dragCanvas(event) {
            //            $('#canvasContainer').offset(event.screenX - window.orignalX);
            $('#perf').text(window.orignalX - event.screenX + " left " + event.screenY + " down");
            var offset = event.screenX - window.orignalX;

            var totalOffset = window.lastXOffset + offset;
            if (totalOffset < 0)
                $('#canvasContainer').offset({ top: 10, left: totalOffset });
        }

        function endMove(event) {
            $('#canvasContainer')[0].onmousemove = null;
            window.lastXOffset = window.lastXOffset + event.screenX - window.orignalX;
            //            alert(event.screenX + " left " + event.screenY + " down")
        }

    </script>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-1211588-8']);
        _gaq.push(['_setDomainName', '.appspot.com']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<div id="content_container" class="scroll" style="position: relative;">
    <div id="canvasContainer" style="position: absolute;"
         onmousedown="startMove(event); return true;"
         onmouseup="endMove(event); return false;">
        <canvas id="entity_canvas_" width=2048px height=768px class="canvas" style="z-index:1000"></canvas>
        <canvas id="message_canvas_" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_0" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_1" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_2" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_3" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_4" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_5" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_6" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_7" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_8" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
        <canvas id="bar_canvas_9" width=2048px height=768px class="canvas" style="z-index:5000"></canvas>
    </div>
</div>


<div id="floating_container" class="expand">
    <div id="script_title" onclick="collapse()">
        <span id="perf">Pseudo Code:</span><span>[Click on the canvas to draw the sequence.]</span></div>
    <div style="float: right;">
            <span id="collapse_button" onclick="collapse()">
            </span>
    </div>
    <div id="script_container">
        <textarea id="script_content"
                  title="Script Content"
                  onblur="window.redraw()"></textarea>
        <script type="text/javascript">
            //            var supported = 'document.ready{\ncanvasManager.new()\n}';
            var supported = '// This is a comment. \ndocument.ready{\n  canvasManager.new(){\n    a = invokeMethod();\n    a.invokeMethod();\n  }\n}';
            var p = document.querySelector('#script_content');
            if (localStorage.script == null) {
                localStorage.script = p.value = supported;
            } else {
                p.value = localStorage.script;
            }
            p.addEventListener('keyup', function() {
                localStorage.script = p.value;
            }, false);

        </script>

    </div>

</div>


<span id=entity_background style=display:none>
    <img id="entity_tl" src="resource/tl.gif"/>
    <img id="entity_tr" src="resource/tr.gif"/>
    <img id="entity_bl" src="resource/bl.gif"/>
    <img id="entity_br" src="resource/br.gif"/>
    <img id="entity_in" src="resource/in.png"/>
 </span>
<span id="for_css_util" style="display:none">
    <span id=entity_box class="entity_box"></span>
    <span id=line class="line"></span>
    <span id=bar class="bar"></span>
    <span id=message class="message"></span>
    <span id=canvas class="canvas"></span>
</span>

<span id="small_arrow_icon" style="display:none">
    <img id="arrow_left" src="resource/arrow_left.gif">
    <img id="arrow_right" src="resource/arrow_right.gif">
</span>
</body>
</html>